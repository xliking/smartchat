# Cloudflare Workers AI Gateway å®Œæ•´éƒ¨ç½²é…ç½®æ•™ç¨‹

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Cloudflare Workers çš„ AI ç½‘å…³ç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹åŠŸèƒ½ï¼š
- OpenAI å…¼å®¹çš„èŠå¤© API
- RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ) åŠŸèƒ½
- æ–‡ä»¶ä¸Šä¼ å’Œæ–‡æœ¬å­˜å‚¨
- å›¾ç‰‡ç”Ÿæˆï¼ˆé€šè¿‡"ç”»"å…³é”®è¯è§¦å‘ï¼‰
- ç®¡ç†å‘˜ç•Œé¢å’Œ API å¯†é’¥ç®¡ç†
- å¯¹è¯éš”ç¦»å’Œå†å²è®°å½•

## ğŸ”§ å‰ç½®å‡†å¤‡

### 1. å®‰è£…å¿…è¦å·¥å…·
```bash
# å®‰è£… Node.js (æ¨è 18+ ç‰ˆæœ¬)
# è®¿é—® https://nodejs.org ä¸‹è½½å®‰è£…

# å®‰è£… Wrangler CLI
npm install -g wrangler

# ç™»å½• Cloudflare è´¦å·
wrangler login
```

### 2. å‡†å¤‡ Cloudflare æœåŠ¡

ç¡®ä¿ä½ çš„ Cloudflare è´¦å·å·²ç»å¼€é€šä»¥ä¸‹æœåŠ¡ï¼š
- Workers (å…è´¹ç‰ˆå³å¯)
- KV å­˜å‚¨
- D1 æ•°æ®åº“
- R2 å¯¹è±¡å­˜å‚¨
- Pages (å¯é€‰ï¼Œç”¨äºè‡ªå®šä¹‰åŸŸå)

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Cloudflare èµ„æº

#### 1.1 åˆ›å»º KV å‘½åç©ºé—´
```bash
# åˆ›å»º KV å‘½åç©ºé—´ç”¨äºå­˜å‚¨é…ç½®å’Œå¯†é’¥
wrangler kv:namespace create "AI_KV"
```
å¤åˆ¶è¿”å›çš„ namespace IDï¼Œç¨åéœ€è¦ç”¨åˆ°ã€‚

#### 1.2 åˆ›å»º D1 æ•°æ®åº“
```bash
# åˆ›å»º D1 æ•°æ®åº“
wrangler d1 create ai-gateway-db
```
å¤åˆ¶è¿”å›çš„ database IDï¼Œç¨åéœ€è¦ç”¨åˆ°ã€‚

#### 1.3 åˆ›å»º R2 å­˜å‚¨æ¡¶
```bash
# åˆ›å»º R2 å­˜å‚¨æ¡¶ç”¨äºæ–‡ä»¶å­˜å‚¨
wrangler r2 bucket create ai-gateway-files
```

### ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
# ä½¿ç”¨ schema.sql åˆå§‹åŒ–æ•°æ®åº“è¡¨
wrangler d1 execute ai-gateway-db --file=./schema.sql
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®é¡¹ç›®

#### 3.1 ä¿®æ”¹ wrangler.toml
æ‰“å¼€ `wrangler.toml` æ–‡ä»¶ï¼Œæ›¿æ¢ä»¥ä¸‹å†…å®¹ï¼š

```toml
name = "ai-gateway"
main = "index.js"
compatibility_date = "2024-01-01"

# æ›¿æ¢ YOUR_KV_NAMESPACE_ID ä¸ºå®é™…çš„ KV namespace ID
[[kv_namespaces]]
binding = "AI_KV"
id = "YOUR_KV_NAMESPACE_ID"

# æ›¿æ¢ YOUR_D1_DATABASE_ID ä¸ºå®é™…çš„ D1 database ID
[[d1_databases]]
binding = "AI_DB"
database_name = "ai-gateway-db"
database_id = "YOUR_D1_DATABASE_ID"

[[r2_buckets]]
binding = "AI_R2"
bucket_name = "ai-gateway-files"

[vars]
ENVIRONMENT = "production"

# å¯é€‰ï¼šé…ç½®è‡ªå®šä¹‰åŸŸå
# [[routes]]
# pattern = "your-ai-gateway.example.com/*"

[compatibility_flags]
nodejs_compat = true
```

#### 3.2 å®‰è£…ä¾èµ–
```bash
npm install
```

### ç¬¬å››æ­¥ï¼šéƒ¨ç½²åˆ° Cloudflare

```bash
# éƒ¨ç½² Workers
wrangler publish

# æˆ–è€…ä½¿ç”¨æ–°ç‰ˆæœ¬å‘½ä»¤
wrangler deploy
```

éƒ¨ç½²æˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š
```
Published ai-gateway (1.0.0)
  https://ai-gateway.your-subdomain.workers.dev
```

### ç¬¬äº”æ­¥ï¼šé¦–æ¬¡é…ç½®

#### 5.1 è®¿é—®ç®¡ç†é¡µé¢
åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä½ çš„ Workers URLï¼ˆä¾‹å¦‚ï¼š`https://ai-gateway.your-subdomain.workers.dev`ï¼‰

#### 5.2 ç³»ç»Ÿåˆå§‹åŒ–
é¦–æ¬¡è®¿é—®ä¼šçœ‹åˆ°åˆå§‹åŒ–é¡µé¢ï¼Œå¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

**ç®¡ç†å‘˜å¯†ç **ï¼šè®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ï¼Œç”¨äºåç»­ç™»å½•ç®¡ç†é¢æ¿

**AI é…ç½®**ï¼š
- AI BaseURL: `https://api.siliconflow.cn`
- AI API Key: ä½ çš„ç¡…åŸºæµåŠ¨ API å¯†é’¥
- AI æ¨¡å‹: `Qwen/QwQ-32B` æˆ–å…¶ä»–æ”¯æŒçš„æ¨¡å‹

**RAG é…ç½®**ï¼š
- RAG BaseURL: `https://api.siliconflow.cn`
- RAG API Key: ä½ çš„ç¡…åŸºæµåŠ¨ API å¯†é’¥
- RAG æ¨¡å‹: `BAAI/bge-large-zh-v1.5`

ç‚¹å‡»"åˆå§‹åŒ–ç³»ç»Ÿ"å®Œæˆè®¾ç½®ã€‚

#### 5.3 è·å– API å¯†é’¥
åˆå§‹åŒ–å®Œæˆåï¼Œç³»ç»Ÿä¼šæ˜¾ç¤ºç¬¬ä¸€ä¸ª API å¯†é’¥ï¼ˆæ ¼å¼ï¼š`sk-xxxxxxxxxx`ï¼‰ï¼Œè¯·å¦¥å–„ä¿å­˜ã€‚

## ğŸ”§ ç®¡ç†é¢æ¿ä½¿ç”¨

### ç™»å½•ç®¡ç†é¢æ¿
ä½¿ç”¨è®¾ç½®çš„ç®¡ç†å‘˜å¯†ç ç™»å½•ç®¡ç†é¢æ¿ã€‚

### ç³»ç»Ÿé…ç½®
- **æœ€å¤§å¯¹è¯æ•°**ï¼šè®¾ç½®æ¯ä¸ªç”¨æˆ·æœ€å¤šä¿ç•™çš„å¯¹è¯è®°å½•æ•°
- **å¯¹å¤–æ¨¡å‹åç§°**ï¼šè®¾ç½®å¯¹å¤–æä¾›çš„æ¨¡å‹åç§°
- **ç³»ç»Ÿæç¤ºè¯**ï¼šè®¾ç½®é»˜è®¤çš„ç³»ç»Ÿæç¤ºè¯
- **å¯ç”¨ç»˜ç”»åŠŸèƒ½**ï¼šå¼€å¯åç”¨æˆ·å‘é€ä»¥"ç”»"å¼€å¤´çš„æ¶ˆæ¯ä¼šè§¦å‘å›¾ç‰‡ç”Ÿæˆ

### API å¯†é’¥ç®¡ç†
- ç‚¹å‡»"ç”Ÿæˆæ–°å¯†é’¥"åˆ›å»ºæ–°çš„ API å¯†é’¥
- å¯ä»¥æ’¤é”€ä¸å†ä½¿ç”¨çš„å¯†é’¥

### æ–‡ä»¶ä¸Šä¼ 
- **ä¸Šä¼ æ–‡ä»¶**ï¼šæ”¯æŒå„ç§æ ¼å¼æ–‡ä»¶ï¼Œç”¨äº RAG æ£€ç´¢
- **ä¸Šä¼ æ–‡æœ¬**ï¼šç›´æ¥è¾“å…¥æ–‡æœ¬å†…å®¹ï¼Œç”¨äº RAG æ£€ç´¢

## ğŸ”Œ API ä½¿ç”¨æ–¹æ³•

### èŠå¤©æ¥å£
```bash
curl --request POST \
  --url https://your-worker-url.workers.dev/v1/chat/completions \
  --header 'Authorization: Bearer sk-your-api-key' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "your-custom-model-name",
    "messages": [
      {
        "role": "user",
        "content": "Hello, how are you?"
      }
    ],
    "stream": false
  }'
```

### æµå¼å“åº”
```bash
curl --request POST \
  --url https://your-worker-url.workers.dev/v1/chat/completions \
  --header 'Authorization: Bearer sk-your-api-key' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "your-custom-model-name",
    "messages": [
      {
        "role": "user",
        "content": "å†™ä¸€é¦–è¯—"
      }
    ],
    "stream": true
  }'
```

### å›¾ç‰‡ç”Ÿæˆ
å‘é€ä»¥"ç”»"å¼€å¤´çš„æ¶ˆæ¯ä¼šè‡ªåŠ¨è§¦å‘å›¾ç‰‡ç”Ÿæˆï¼š
```bash
curl --request POST \
  --url https://your-worker-url.workers.dev/v1/chat/completions \
  --header 'Authorization: Bearer sk-your-api-key' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "your-custom-model-name",
    "messages": [
      {
        "role": "user",
        "content": "ç”»ä¸€åªå¯çˆ±çš„å°çŒ«"
      }
    ]
  }'
```

## ğŸŒ è‡ªå®šä¹‰åŸŸåé…ç½®ï¼ˆå¯é€‰ï¼‰

### æ–¹æ³•ä¸€ï¼šé€šè¿‡ Routes
1. åœ¨ Cloudflare Dashboard ä¸­æ·»åŠ ä½ çš„åŸŸå
2. åœ¨ `wrangler.toml` ä¸­æ·»åŠ è·¯ç”±é…ç½®ï¼š
```toml
[[routes]]
pattern = "api.yourdomain.com/*"
zone_name = "yourdomain.com"
```
3. é‡æ–°éƒ¨ç½²ï¼š`wrangler deploy`

### æ–¹æ³•äºŒï¼šé€šè¿‡ Pages
1. åˆ›å»ºä¸€ä¸ªæ–°çš„ Pages é¡¹ç›®
2. è®¾ç½®è‡ªå®šä¹‰åŸŸå
3. é…ç½® Functions è·¯ç”±

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
wrangler tail ai-gateway
```

### æŸ¥çœ‹æŒ‡æ ‡
åœ¨ Cloudflare Dashboard çš„ Workers éƒ¨åˆ†å¯ä»¥æŸ¥çœ‹ï¼š
- è¯·æ±‚æ•°é‡
- å“åº”æ—¶é—´
- é”™è¯¯ç‡
- CPU ä½¿ç”¨æ—¶é—´

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. éƒ¨ç½²å¤±è´¥
- æ£€æŸ¥ `wrangler.toml` ä¸­çš„ ID æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æ‰€æœ‰å¿…è¦çš„æœåŠ¡éƒ½å·²åˆ›å»º
- æ£€æŸ¥ Wrangler ç‰ˆæœ¬æ˜¯å¦æœ€æ–°

#### 2. API è°ƒç”¨å¤±è´¥
- æ£€æŸ¥ API å¯†é’¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç¡…åŸºæµåŠ¨ API å¯†é’¥æœ‰æ•ˆ
- æŸ¥çœ‹ Workers æ—¥å¿—æ’æŸ¥é”™è¯¯

#### 3. RAG åŠŸèƒ½ä¸å·¥ä½œ
- ç¡®è®¤å·²ä¸Šä¼ æ–‡ä»¶æˆ–æ–‡æœ¬
- æ£€æŸ¥ RAG æ¨¡å‹é…ç½®æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹æ•°æ®åº“æ˜¯å¦æ­£å¸¸åˆ›å»º

#### 4. æ–‡ä»¶ä¸Šä¼ å¤±è´¥
- æ£€æŸ¥ R2 å­˜å‚¨æ¡¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
- ç¡®è®¤æ–‡ä»¶å¤§å°ä¸è¶…è¿‡é™åˆ¶
- æŸ¥çœ‹ä¸Šä¼ æƒé™æ˜¯å¦æ­£ç¡®

### è°ƒè¯•å‘½ä»¤
```bash
# æœ¬åœ°å¼€å‘æ¨¡å¼
npm run dev

# æŸ¥çœ‹ KV å­˜å‚¨å†…å®¹
wrangler kv:key list --namespace-id=YOUR_NAMESPACE_ID

# æŸ¥çœ‹ D1 æ•°æ®åº“å†…å®¹
wrangler d1 execute ai-gateway-db --command="SELECT * FROM files LIMIT 10"

# æŸ¥çœ‹ R2 å­˜å‚¨å†…å®¹
wrangler r2 object list ai-gateway-files
```

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ä¿æŠ¤ç®¡ç†å‘˜å¯†ç **ï¼šä½¿ç”¨å¼ºå¯†ç å¹¶å®šæœŸæ›´æ”¹
2. **API å¯†é’¥ç®¡ç†**ï¼šå®šæœŸè½®æ¢ API å¯†é’¥
3. **è®¿é—®æ§åˆ¶**ï¼šè€ƒè™‘æ·»åŠ  IP ç™½åå•
4. **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®åœ¨å­˜å‚¨å‰è¿›è¡ŒåŠ å¯†
5. **ç›‘æ§å¼‚å¸¸**ï¼šè®¾ç½®å‘Šè­¦ç›‘æ§å¼‚å¸¸è®¿é—®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜ç­–ç•¥**ï¼šå¯¹é¢‘ç¹æŸ¥è¯¢çš„å†…å®¹å¯ç”¨ç¼“å­˜
2. **æ‰¹é‡å¤„ç†**ï¼šå¯¹æ‰¹é‡è¯·æ±‚è¿›è¡Œä¼˜åŒ–
3. **èµ„æºé™åˆ¶**ï¼šè®¾ç½®åˆç†çš„é€Ÿç‡é™åˆ¶
4. **æ•°æ®æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„å¯¹è¯è®°å½•

## ğŸ†™ å‡çº§ç»´æŠ¤

### æ›´æ–°ä»£ç 
```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# é‡æ–°éƒ¨ç½²
wrangler deploy
```

### æ•°æ®åº“è¿ç§»
å¦‚æœéœ€è¦ä¿®æ”¹æ•°æ®åº“ç»“æ„ï¼š
```bash
# åˆ›å»ºè¿ç§» SQL æ–‡ä»¶
# æ‰§è¡Œè¿ç§»
wrangler d1 execute ai-gateway-db --file=./migration.sql
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹ Cloudflare Workers å®˜æ–¹æ–‡æ¡£
2. æ£€æŸ¥é¡¹ç›® GitHub Issues
3. æŸ¥çœ‹ Cloudflare Community è®ºå›

## ğŸ‰ å®Œæˆ

æ­å–œï¼ä½ å·²ç»æˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ AI Gateway ç³»ç»Ÿã€‚ç°åœ¨ä½ å¯ä»¥ï¼š
- é€šè¿‡ç®¡ç†é¢æ¿ç®¡ç†ç³»ç»Ÿé…ç½®
- ä½¿ç”¨ API å¯†é’¥è°ƒç”¨ AI æœåŠ¡
- äº«å— RAG å¢å¼ºçš„å¯¹è¯ä½“éªŒ
- ä½¿ç”¨ç»˜ç”»åŠŸèƒ½ç”Ÿæˆå›¾ç‰‡

è®°ä½è¦å®šæœŸå¤‡ä»½é‡è¦æ•°æ®ï¼Œå¹¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ã€‚