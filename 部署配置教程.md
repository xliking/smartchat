# Cloudflare Workers AI Gateway 完整部署配置教程

## 📋 项目概述

这是一个基于 Cloudflare Workers 的 AI 网关系统，具备以下功能：
- OpenAI 兼容的聊天 API
- RAG (检索增强生成) 功能
- 文件上传和文本存储
- 图片生成（通过"画"关键词触发）
- 管理员界面和 API 密钥管理
- 对话隔离和历史记录

## 🔧 前置准备

### 1. 安装必要工具
```bash
# 安装 Node.js (推荐 18+ 版本)
# 访问 https://nodejs.org 下载安装

# 安装 Wrangler CLI
npm install -g wrangler

# 登录 Cloudflare 账号
wrangler login
```

### 2. 准备 Cloudflare 服务

确保你的 Cloudflare 账号已经开通以下服务：
- Workers (免费版即可)
- KV 存储
- D1 数据库
- R2 对象存储
- Pages (可选，用于自定义域名)

## 🚀 部署步骤

### 第一步：创建 Cloudflare 资源

#### 1.1 创建 KV 命名空间
```bash
# 创建 KV 命名空间用于存储配置和密钥
wrangler kv:namespace create "AI_KV"
```
复制返回的 namespace ID，稍后需要用到。

#### 1.2 创建 D1 数据库
```bash
# 创建 D1 数据库
wrangler d1 create ai-gateway-db
```
复制返回的 database ID，稍后需要用到。

#### 1.3 创建 R2 存储桶
```bash
# 创建 R2 存储桶用于文件存储
wrangler r2 bucket create ai-gateway-files
```

### 第二步：初始化数据库

```bash
# 使用 schema.sql 初始化数据库表
wrangler d1 execute ai-gateway-db --file=./schema.sql
```

### 第三步：配置项目

#### 3.1 修改 wrangler.toml
打开 `wrangler.toml` 文件，替换以下内容：

```toml
name = "ai-gateway"
main = "index.js"
compatibility_date = "2024-01-01"

# 替换 YOUR_KV_NAMESPACE_ID 为实际的 KV namespace ID
[[kv_namespaces]]
binding = "AI_KV"
id = "YOUR_KV_NAMESPACE_ID"

# 替换 YOUR_D1_DATABASE_ID 为实际的 D1 database ID
[[d1_databases]]
binding = "AI_DB"
database_name = "ai-gateway-db"
database_id = "YOUR_D1_DATABASE_ID"

[[r2_buckets]]
binding = "AI_R2"
bucket_name = "ai-gateway-files"

[vars]
ENVIRONMENT = "production"

# 可选：配置自定义域名
# [[routes]]
# pattern = "your-ai-gateway.example.com/*"

[compatibility_flags]
nodejs_compat = true
```

#### 3.2 安装依赖
```bash
npm install
```

### 第四步：部署到 Cloudflare

```bash
# 部署 Workers
wrangler publish

# 或者使用新版本命令
wrangler deploy
```

部署成功后，你会看到类似的输出：
```
Published ai-gateway (1.0.0)
  https://ai-gateway.your-subdomain.workers.dev
```

### 第五步：首次配置

#### 5.1 访问管理页面
在浏览器中打开你的 Workers URL（例如：`https://ai-gateway.your-subdomain.workers.dev`）

#### 5.2 系统初始化
首次访问会看到初始化页面，填写以下信息：

**管理员密码**：设置一个强密码，用于后续登录管理面板

**AI 配置**：
- AI BaseURL: `https://api.siliconflow.cn`
- AI API Key: 你的硅基流动 API 密钥
- AI 模型: `Qwen/QwQ-32B` 或其他支持的模型

**RAG 配置**：
- RAG BaseURL: `https://api.siliconflow.cn`
- RAG API Key: 你的硅基流动 API 密钥
- RAG 模型: `BAAI/bge-large-zh-v1.5`

点击"初始化系统"完成设置。

#### 5.3 获取 API 密钥
初始化完成后，系统会显示第一个 API 密钥（格式：`sk-xxxxxxxxxx`），请妥善保存。

## 🔧 管理面板使用

### 登录管理面板
使用设置的管理员密码登录管理面板。

### 系统配置
- **最大对话数**：设置每个用户最多保留的对话记录数
- **对外模型名称**：设置对外提供的模型名称
- **系统提示词**：设置默认的系统提示词
- **启用绘画功能**：开启后用户发送以"画"开头的消息会触发图片生成

### API 密钥管理
- 点击"生成新密钥"创建新的 API 密钥
- 可以撤销不再使用的密钥

### 文件上传
- **上传文件**：支持各种格式文件，用于 RAG 检索
- **上传文本**：直接输入文本内容，用于 RAG 检索

## 🔌 API 使用方法

### 聊天接口
```bash
curl --request POST \
  --url https://your-worker-url.workers.dev/v1/chat/completions \
  --header 'Authorization: Bearer sk-your-api-key' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "your-custom-model-name",
    "messages": [
      {
        "role": "user",
        "content": "Hello, how are you?"
      }
    ],
    "stream": false
  }'
```

### 流式响应
```bash
curl --request POST \
  --url https://your-worker-url.workers.dev/v1/chat/completions \
  --header 'Authorization: Bearer sk-your-api-key' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "your-custom-model-name",
    "messages": [
      {
        "role": "user",
        "content": "写一首诗"
      }
    ],
    "stream": true
  }'
```

### 图片生成
发送以"画"开头的消息会自动触发图片生成：
```bash
curl --request POST \
  --url https://your-worker-url.workers.dev/v1/chat/completions \
  --header 'Authorization: Bearer sk-your-api-key' \
  --header 'Content-Type: application/json' \
  --data '{
    "model": "your-custom-model-name",
    "messages": [
      {
        "role": "user",
        "content": "画一只可爱的小猫"
      }
    ]
  }'
```

## 🌐 自定义域名配置（可选）

### 方法一：通过 Routes
1. 在 Cloudflare Dashboard 中添加你的域名
2. 在 `wrangler.toml` 中添加路由配置：
```toml
[[routes]]
pattern = "api.yourdomain.com/*"
zone_name = "yourdomain.com"
```
3. 重新部署：`wrangler deploy`

### 方法二：通过 Pages
1. 创建一个新的 Pages 项目
2. 设置自定义域名
3. 配置 Functions 路由

## 🔍 监控和日志

### 查看实时日志
```bash
wrangler tail ai-gateway
```

### 查看指标
在 Cloudflare Dashboard 的 Workers 部分可以查看：
- 请求数量
- 响应时间
- 错误率
- CPU 使用时间

## 🛠️ 故障排除

### 常见问题

#### 1. 部署失败
- 检查 `wrangler.toml` 中的 ID 是否正确
- 确保所有必要的服务都已创建
- 检查 Wrangler 版本是否最新

#### 2. API 调用失败
- 检查 API 密钥是否正确
- 确认硅基流动 API 密钥有效
- 查看 Workers 日志排查错误

#### 3. RAG 功能不工作
- 确认已上传文件或文本
- 检查 RAG 模型配置是否正确
- 查看数据库是否正常创建

#### 4. 文件上传失败
- 检查 R2 存储桶是否创建成功
- 确认文件大小不超过限制
- 查看上传权限是否正确

### 调试命令
```bash
# 本地开发模式
npm run dev

# 查看 KV 存储内容
wrangler kv:key list --namespace-id=YOUR_NAMESPACE_ID

# 查看 D1 数据库内容
wrangler d1 execute ai-gateway-db --command="SELECT * FROM files LIMIT 10"

# 查看 R2 存储内容
wrangler r2 object list ai-gateway-files
```

## 🔒 安全注意事项

1. **保护管理员密码**：使用强密码并定期更改
2. **API 密钥管理**：定期轮换 API 密钥
3. **访问控制**：考虑添加 IP 白名单
4. **数据加密**：敏感数据在存储前进行加密
5. **监控异常**：设置告警监控异常访问

## 📈 性能优化

1. **缓存策略**：对频繁查询的内容启用缓存
2. **批量处理**：对批量请求进行优化
3. **资源限制**：设置合理的速率限制
4. **数据清理**：定期清理过期的对话记录

## 🆙 升级维护

### 更新代码
```bash
# 拉取最新代码
git pull origin main

# 重新部署
wrangler deploy
```

### 数据库迁移
如果需要修改数据库结构：
```bash
# 创建迁移 SQL 文件
# 执行迁移
wrangler d1 execute ai-gateway-db --file=./migration.sql
```

## 📞 技术支持

如果遇到问题，可以：
1. 查看 Cloudflare Workers 官方文档
2. 检查项目 GitHub Issues
3. 查看 Cloudflare Community 论坛

## 🎉 完成

恭喜！你已经成功部署了一个功能完整的 AI Gateway 系统。现在你可以：
- 通过管理面板管理系统配置
- 使用 API 密钥调用 AI 服务
- 享受 RAG 增强的对话体验
- 使用绘画功能生成图片

记住要定期备份重要数据，并监控系统运行状态。