# AI Gateway 完整部署指南

> 本指南适用于完全没有技术基础的用户，按步骤操作即可完成部署

## 📋 部署前准备

### 1. 注册 Cloudflare 账号
1. 访问 [Cloudflare 官网](https://www.cloudflare.com)
2. 点击右上角 "Sign Up" 注册账号
3. 验证邮箱后登录

### 2. 安装 Node.js
1. 访问 [Node.js 官网](https://nodejs.org)
2. 下载Node，版本 > 16.0
3. 运行下载的安装程序，一路点击"下一步"
4. 安装完成后，按 `Win + R`，输入 `cmd`，按回车
5. 在命令行中输入 `node --version`，如果显示版本号则安装成功

## 🚀 部署步骤

### 第一步：下载项目文件
1. 将提供的项目文件夹解压到桌面
2. 确保文件夹包含以下文件：
   - `package.json`
   - `worker.js`
   - `index.html`
   - `app.js`
   - `wrangler.toml`
   - 其他配置文件

### 第二步：安装 Wrangler CLI
1. 按 `Win + R`，输入 `cmd`，按回车打开命令行
2. 输入以下命令安装 Wrangler：
   ```bash
   npm install -g wrangler
   ```
3. 等待安装完成（可能需要几分钟）

### 第三步：登录 Cloudflare 账号
1. 在命令行中输入：
   ```bash
   wrangler auth login
   ```
2. 会自动打开浏览器，点击"允许"授权
3. 看到"Successfully logged in"表示登录成功

### 第四步：创建 Cloudflare 资源

#### 创建 KV 存储
```bash
wrangler kv:namespace create "AI_KV"
```
记录返回的命名空间 ID（类似：`5d41a451ec284a21816b8d096b090e71`）

#### 创建 D1 数据库
```bash
wrangler d1 create ai-gateway-db
```
记录返回的数据库 ID

#### 创建 R2 存储桶
```bash
wrangler r2 bucket create ai-gateway-files
```

### 第五步：更新配置文件
1. 用记事本打开项目文件夹中的 `wrangler.toml` 文件
2. 将第18行的 KV ID 替换为刚才记录的 ID
3. 将第24行的数据库 ID 替换为刚才记录的 ID
4. 如果需要自定义域名，修改第12行的域名地址
5. 保存文件

### 第六步：初始化数据库
1. 在命令行中切换到项目目录：
   ```bash
   cd "C:\Users\Administrator\Desktop\auth"
   ```
2. 初始化数据库结构：
   ```bash
   wrangler d1 execute ai-gateway-db --file=./complete-setup.sql --env production
   ```

### 第七步：配置API域名地址 ⚠️ 重要步骤
在部署之前，必须修改前端的API地址为你自己的Worker域名。

#### 7.1 修改API地址
1. 用记事本打开项目文件夹中的 `app.js` 文件
2. 找到第2行：
   ```javascript
   let API_BASE_URL = 'https://ai-gateway.easyapi.me';
   ```
3. 将地址修改为你的Worker域名：
   ```javascript
   let API_BASE_URL = 'https://你的worker名称.你的账号.workers.dev';
   ```
   > 📌 **注意**：Worker域名格式通常是 `项目名称.账号名.workers.dev`

#### 7.2 获取正确的Worker域名
如果不确定Worker域名，可以：
1. 先执行第八步部署Worker
2. 部署成功后会显示Worker访问地址
3. 复制这个地址，回来修改 `app.js` 文件
4. 重新部署Pages

#### 7.3 完整示例
假设你的Cloudflare账号是 `john123`，Worker名称是 `ai-gateway`，那么：

**修改 app.js：**
```javascript
let API_BASE_URL = 'https://ai-gateway.john123.workers.dev';
```

💡 **简化说明**：当前项目只需要修改 `app.js` 一个文件即可！

### 第八步：部署应用
1. 部署 Worker：
   ```bash
   wrangler publish --env production
   ```
2. 部署管理界面：
   ```bash
   wrangler pages publish . --project-name ai-gateway-admin
   ```

## 🔧 部署后配置

### 1. 访问管理界面
- 部署成功后，会显示访问地址
- 首次访问会自动设置管理员密码

### 2. 配置 AI 服务
1. 登录管理界面
2. 在"AI 配置"中设置：
   - **Base URL**: `https://api.siliconflow.cn/v1`
   - **API Key**: 你的硅基流动 API 密钥
   - **默认模型**: 选择适合的模型

### 3. 配置 RAG 功能（可选）
1. 设置嵌入模型和重排序模型
2. 上传知识库文件或文本
3. 测试检索功能

### 4. 生成 API 密钥
1. 在"API 密钥管理"中点击"生成新密钥"
2. 复制生成的密钥（格式：sk-xxxxx）
3. 使用此密钥调用 AI 服务

## 📖 使用说明

### API 调用示例
```bash
curl -X POST "https://your-worker-domain/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer sk-your-api-key" \
  -d '{
    "model": "your-model-name",
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

### 管理界面功能
- **AI 配置**: 设置基础 AI 服务参数
- **RAG 配置**: 配置检索增强生成功能
- **API 密钥管理**: 生成和管理访问密钥
- **文件上传**: 上传知识库文件
- **系统设置**: 配置系统参数

## ❓ 常见问题

### 部署失败怎么办？
1. 确认 Cloudflare 账号已登录：`wrangler auth whoami`
2. 检查网络连接是否正常
3. 确保所有资源 ID 配置正确
4. 查看错误信息，通常会提示具体问题

### 无法访问管理界面？
1. 确认域名解析是否生效（需要等待几分钟）
2. 检查 Cloudflare 控制台中的路由规则
3. 尝试使用 Workers 默认域名访问

### API 调用报错？
1. 检查 API 密钥是否正确
2. 确认请求格式符合 OpenAI 标准
3. 查看 Worker 日志：`wrangler tail --env production`

### 数据库操作失败？
1. 确认数据库已正确创建和绑定
2. 检查 SQL 文件是否完整执行
3. 尝试重新执行初始化命令

## 🛠 维护命令

### 查看日志
```bash
wrangler tail --env production
```

### 更新部署
```bash
wrangler publish --env production
```

### 数据库查询
```bash
wrangler d1 execute ai-gateway-db --command "SELECT * FROM files LIMIT 10" --env production
```

### KV 存储查看
```bash
wrangler kv:key list --namespace-id your-kv-id
```

## 技术支持

如遇到问题，请提供：
1. 具体的错误信息
2. 执行的命令

---

## 🎯 快速开始检查清单

- [ ] Cloudflare 账号已注册并登录
- [ ] Node.js 和 Wrangler 已安装
- [ ] KV、D1、R2 资源已创建
- [ ] wrangler.toml 配置已更新（资源ID）
- [ ] **app.js 中的 API_BASE_URL 已修改为你的Worker域名**
- [ ] 数据库已初始化
- [ ] Worker 和 Pages 已部署
- [ ] 管理界面可正常访问
- [ ] AI 服务配置已完成
- [ ] API 密钥已生成并测试

⚠️ **重要提醒**：步骤5-6（域名配置）是最容易遗漏但最重要的步骤！。

完成以上步骤后，你的 SmartChat Engine 就可以正常使用了！